<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Quotes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Noto+Sans+KR:wght@400;700&display=swap');
        :root { --bg-color: #e0e7ff; --window-bg: #fff1e6; --border-color: #2d2d2d; --accent-blue: #93c5fd; --accent-red: #fca5a5; --accent-yellow: #fbbf24; }
        body { font-family: 'Noto Sans KR', sans-serif; background-color: var(--bg-color); background-image: linear-gradient(var(--accent-blue) 1px, transparent 1px), linear-gradient(90deg, var(--accent-blue) 1px, transparent 1px); background-size: 20px 20px; color: var(--border-color); overflow-x: hidden; }
        .retro-box { background-color: var(--window-bg); border: 3px solid var(--border-color); box-shadow: 6px 6px 0px rgba(0,0,0,0.8); border-radius: 0px; transition: transform 0.1s, box-shadow 0.1s; }
        .retro-input { width: 100%; background: white; border: 2px solid var(--border-color); padding: 10px; font-family: 'VT323', monospace; font-size: 1.2rem; outline: none; box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1); }
        .retro-input:focus { background: #fff; box-shadow: inset 2px 2px 0px rgba(0,0,0,0.2); }
        .retro-btn { background-color: var(--accent-yellow); border: 2px solid var(--border-color); padding: 8px 16px; font-weight: bold; text-transform: uppercase; cursor: pointer; box-shadow: 2px 2px 0px var(--border-color); display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .retro-btn:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px var(--border-color); }
        .retro-btn.primary { background-color: var(--accent-yellow); }
        .retro-btn.danger { background-color: var(--accent-red); }
        .retro-btn.success { background-color: #86efac; }
        .retro-btn.neutral { background-color: #e5e7eb; }
        .title-bar { background-color: var(--accent-blue); border-bottom: 3px solid var(--border-color); padding: 5px 10px; display: flex; justify-content: space-between; align-items: center; font-family: 'VT323', monospace; font-size: 1.2rem; color: var(--border-color); font-weight: bold; }
        .pixel-font { font-family: 'VT323', monospace; }
        .tab-active { background-color: var(--window-bg) !important; border-bottom: none !important; position: relative; top: 2px; }
        @keyframes flip { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } }
        .loading-icon { animation: flip 2s infinite ease-in-out; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 20px; padding-bottom: 80px; }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <!-- 1. Î°úÍ∑∏Ïù∏ ÌôîÎ©¥ -->
        <div id="auth-screen" class="flex flex-col gap-6 justify-center min-h-[80vh]">
            <div class="retro-box p-0">
                <div class="title-bar"><span>SYSTEM_LOGIN.EXE</span><div class="flex gap-1"><div class="w-3 h-3 border border-black bg-white"></div><div class="w-3 h-3 border border-black bg-white"></div></div></div>
                <div class="p-6 flex flex-col gap-4">
                    <div class="text-center mb-4"><h1 class="text-3xl font-bold pixel-font">RETRO QUOTES</h1><p class="text-sm text-gray-600">ÎãπÏã†Ïùò ÏòÅÍ∞êÏùÑ Í∏∞Î°ùÌïòÏÑ∏Ïöî</p></div>
                    <div class="flex gap-2 mb-2">
                        <button onclick="switchAuthMode('login')" id="tab-login" class="retro-btn flex-1 bg-white">Î°úÍ∑∏Ïù∏</button>
                        <button onclick="switchAuthMode('signup')" id="tab-signup" class="retro-btn flex-1 bg-gray-200">Í∞ÄÏûÖ</button>
                    </div>
                    <form id="auth-form" onsubmit="handleAuth(event)">
                        <div class="flex flex-col gap-3">
                            <input type="email" id="email" placeholder="E-MAIL" class="retro-input" required>
                            <input type="password" id="password" placeholder="PASSWORD" class="retro-input" required>
                            <div id="signup-fields" class="hidden flex flex-col gap-3">
                                <input type="text" id="nickname" placeholder="NICKNAME" class="retro-input">
                                <input type="text" id="profileUrl" placeholder="PROFILE IMG URL" class="retro-input">
                            </div>
                            <button type="submit" class="retro-btn primary w-full mt-4 h-12 text-lg">ENTER SYSTEM</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- 2. Î©îÏù∏ ÌîºÎìú -->
        <div id="main-screen" class="hidden">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold pixel-font bg-white border-2 border-black px-2 shadow-[2px_2px_0px_rgba(0,0,0,1)]">QUOTES_FEED</h2>
                <button onclick="goToMyPage()" class="retro-btn success text-xs px-3 py-1">MY PAGE</button>
            </header>
            <div class="mb-6 retro-box p-2 flex gap-2"><i data-lucide="search" class="w-6 h-6"></i><input type="text" placeholder="Search quotes..." class="bg-transparent outline-none w-full font-mono"></div>
            <div id="quotes-list" class="flex flex-col gap-6"></div>
        </div>

        <!-- 3. ÎßàÏù¥ÌéòÏù¥ÏßÄ -->
        <div id="mypage-screen" class="hidden">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold pixel-font bg-white border-2 border-black px-2 shadow-[2px_2px_0px_rgba(0,0,0,1)]">MY_PAGE</h2>
                <div class="flex gap-2"><button onclick="showMainScreen()" class="retro-btn neutral text-xs px-2 py-1">HOME</button><button onclick="logout()" class="retro-btn danger text-xs px-2 py-1">LOGOUT</button></div>
            </header>
            <div class="retro-box p-4 mb-6 flex items-center gap-4">
                <div class="w-16 h-16 bg-gray-300 border-2 border-black overflow-hidden relative">
                     <img id="my-profile-img" src="" onerror="this.src='https://via.placeholder.com/150'" class="w-full h-full object-cover hidden">
                     <i data-lucide="user" class="w-8 h-8 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-500"></i>
                </div>
                <div><h3 id="my-nickname" class="text-xl font-bold pixel-font">LOADING...</h3><p id="my-email" class="text-xs text-gray-500">user@email.com</p><span id="my-role" class="text-[10px] bg-blue-200 px-1 border border-black mt-1 inline-block">USER</span></div>
            </div>
            <div class="flex border-b-2 border-black mb-4 px-2 gap-2">
                <button onclick="switchMyPageTab('my-quotes')" id="btn-tab-my" class="retro-btn bg-gray-300 border-b-0 rounded-b-none px-4 py-2 text-sm">ÎÇ¥Í∞Ä Ïì¥ Í∏Ä</button>
                <button onclick="switchMyPageTab('likes')" id="btn-tab-likes" class="retro-btn bg-gray-300 border-b-0 rounded-b-none px-4 py-2 text-sm">Ï¢ãÏïÑÏöî</button>
            </div>
            <div id="mypage-list" class="flex flex-col gap-4"></div>
        </div>

        <!-- Í∏ÄÏì∞Í∏∞ Î≤ÑÌäº -->
        <button onclick="openModal()" id="fab-btn" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-[#86efac] border-2 border-black shadow-[4px_4px_0px_rgba(0,0,0,1)] flex items-center justify-center rounded-full hover:translate-y-1 transition-all z-50"><i data-lucide="plus" class="w-8 h-8 text-black"></i></button>
    </div>

    <!-- Î™®Îã¨ -->
    <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-[100] flex items-center justify-center p-4">
        <div class="retro-box w-full max-w-md bg-[#fff1e6] animate-bounce-in relative">
            <div class="title-bar bg-[#fca5a5]"><span>NEW_QUOTE.TXT</span><button onclick="closeModal()" class="hover:bg-red-400 p-1"><i data-lucide="x" class="w-4 h-4"></i></button></div>
            <form id="quote-form" onsubmit="createQuote(event)" class="p-4 flex flex-col gap-3">
                <label class="text-xs font-bold">SENTENCE</label><textarea id="q-sentence" rows="3" class="retro-input" placeholder="Ïó¨Í∏∞Ïóê Î¨∏Ïû•ÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî..." required></textarea>
                <label class="text-xs font-bold">THOUGHT</label><textarea id="q-thought" rows="2" class="retro-input" placeholder="ÎãπÏã†Ïùò ÏÉùÍ∞ÅÏùÄ?"></textarea>
                <div class="grid grid-cols-2 gap-2"><div><label class="text-xs font-bold">AUTHOR</label><input type="text" id="q-author" class="retro-input" placeholder="Ï†ÄÏûê"></div><div><label class="text-xs font-bold">PAGE</label><input type="number" id="q-page" class="retro-input" placeholder="ÌéòÏù¥ÏßÄ"></div></div>
                <div class="grid grid-cols-2 gap-2">
                    <div><label class="text-xs font-bold">CATEGORY</label><select id="q-category" class="retro-input"><option value="NOVEL">ÏÜåÏÑ§</option><option value="POETRY">Ïãú</option><option value="SCENARIO">ÏãúÎÇòÎ¶¨Ïò§</option><option value="ESSAY">ÏàòÌïÑ</option><option value="PLAY">Ìù¨Í≥°</option><option value="AUTOBIOGRAPHY">ÏûêÏÑúÏ†Ñ</option><option value="MEMOIR">ÌöåÍ≥†Î°ù</option><option value="CHILDREN_LITERATURE">ÏïÑÎèôÎ¨∏Ìïô</option><option value="CRITICISM">Î¨∏ÌïôÎπÑÌèâ</option></select></div>
                    <div><label class="text-xs font-bold">PUBLIC</label><select id="q-public" class="retro-input"><option value="PUBLIC">Í≥µÍ∞ú</option><option value="PRIVATE">ÎπÑÍ≥µÍ∞ú</option></select></div>
                </div>
                <label class="text-xs font-bold">TITLE (BOOK)</label><input type="text" id="q-title" class="retro-input" placeholder="Ï±Ö Ï†úÎ™©" required>
                <div class="flex gap-2 mt-4"><button type="button" onclick="closeModal()" class="retro-btn w-1/2">CANCEL</button><button type="submit" class="retro-btn success w-1/2">SAVE</button></div>
            </form>
        </div>
    </div>
    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-black text-white px-6 py-3 border-2 border-white shadow-lg hidden z-[200] pixel-font">MESSAGE HERE</div>

    <script>
        const API_BASE_URL = "http://localhost:8080"; 
        let currentAuthMode = 'login', currentMyPageTab = 'my-quotes', token = localStorage.getItem('accessToken'), myProfile = {};

        document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); checkAuth(); });

        // ===============================================
        // [New] Ïù∏Ï¶ù ÎûòÌçº Ìï®Ïàò (Interceptor Ïó≠Ìï†)
        // ===============================================
        async function fetchWithAuth(url, options = {}) {
            // Ìó§Îçî ÏûêÎèô Î≥ëÌï©
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': token, // ÌòÑÏû¨ ÌÜ†ÌÅ∞ ÏÇ¨Ïö©
                ...options.headers
            };

            try {
                const response = await fetch(`${API_BASE_URL}${url}`, { ...options, headers });

                // [ÌïµÏã¨] 401 ÎßåÎ£å ÏóêÎü¨ Í∞êÏßÄ Î°úÏßÅ
                if (response.status === 401) {
                    // ÏùëÎãµ Î≥∏Î¨∏ÏùÑ ÏùΩÏñ¥ÏÑú ÏóêÎü¨ Î©îÏãúÏßÄ ÌôïÏù∏
                    // (clone()ÏùÑ Ïì∞Îäî Ïù¥Ïú†Îäî response bodyÎäî Ìïú Î≤à ÏùΩÏúºÎ©¥ ÏÇ¨ÎùºÏßÄÍ∏∞ ÎïåÎ¨∏)
                    const errorText = await response.clone().text(); 
                    
                    if (errorText.includes("Expired") || errorText.includes("ÎßåÎ£åÎêú")) {
                        showToast("‚ö†Ô∏è Ïù∏Ï¶ù ÏÑ∏ÏÖòÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
                        
                        // 2Ï¥à Îí§ Î°úÍ∑∏ÏïÑÏõÉ Ï≤òÎ¶¨ (ÌÜ†Ïä§Ìä∏ Î©îÏãúÏßÄ ÏùΩÏùÑ ÏãúÍ∞Ñ ÌôïÎ≥¥)
                        setTimeout(() => {
                            logout(); 
                        }, 2000);
                        
                        // Îçî Ïù¥ÏÉÅ ÏßÑÌñâÌïòÏßÄ ÏïäÎèÑÎ°ù ÏóêÎü¨ throw
                        throw new Error("TOKEN_EXPIRED");
                    }
                }
                return response;
            } catch (err) {
                // TOKEN_EXPIRED ÏóêÎü¨Îäî Ïù¥ÎØ∏ Ï≤òÎ¶¨ÌñàÏúºÎØÄÎ°ú Ï°∞Ïö©Ìûà ÎÑòÍ∏∞Í±∞ÎÇò ÏÉÅÏúÑÎ°ú Ï†ÑÌåå
                throw err;
            }
        }

        // 1. Auth Logic
        function checkAuth() { if (token) { showMainScreen(); fetchQuotes(); fetchMyProfile(); } else { showAuthScreen(); } }
        
        function switchAuthMode(mode) {
            currentAuthMode = mode;
            const signup = document.getElementById('signup-fields'), tabLogin = document.getElementById('tab-login'), tabSignup = document.getElementById('tab-signup'), btn = document.querySelector('#auth-form button');
            if (mode === 'signup') { 
                signup.classList.remove('hidden'); 
                tabSignup.classList.add('bg-white'); tabSignup.classList.remove('bg-gray-200'); 
                tabLogin.classList.remove('bg-white'); tabLogin.classList.add('bg-gray-200'); 
                btn.innerText = "REGISTER USER"; 
            } 
            else { 
                signup.classList.add('hidden'); 
                tabLogin.classList.add('bg-white'); tabLogin.classList.remove('bg-gray-200'); 
                tabSignup.classList.remove('bg-white'); tabSignup.classList.add('bg-gray-200'); 
                btn.innerText = "ENTER SYSTEM"; 
            }
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value, password = document.getElementById('password').value, endpoint = currentAuthMode === 'login' ? '/signin' : '/signup';
            const body = { email, password };
            
            if (currentAuthMode === 'signup') { 
                body.nickname = document.getElementById('nickname').value; 
                body.profileUrl = document.getElementById('profileUrl').value; 
                body.userRole = 'USER'; 
            }
            try {
                // Î°úÍ∑∏Ïù∏ÏùÄ ÌÜ†ÌÅ∞ ÏóÜÏù¥ ÌïòÎäî ÏöîÏ≤≠Ïù¥ÎØÄÎ°ú Í∑∏ÎÉ• fetch ÏÇ¨Ïö©
                const res = await fetch(`${API_BASE_URL}${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (!res.ok) throw new Error('Ïù∏Ï¶ù Ïã§Ìå®! Ïù¥Î©îÏùº/ÎπÑÎ≤àÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
                const data = await res.json();
                if (currentAuthMode === 'signup') { showToast("ÌöåÏõêÍ∞ÄÏûÖ ÏôÑÎ£å! Î°úÍ∑∏Ïù∏ÌïòÏÑ∏Ïöî."); switchAuthMode('login'); } 
                else { token = data.token; localStorage.setItem('accessToken', token); showToast("ÏãúÏä§ÌÖú Ï†ëÏÜç ÏÑ±Í≥µ"); checkAuth(); }
            } catch (err) { showToast(err.message); }
        }
        function logout() { localStorage.clear(); token = null; location.reload(); }
        
        // [ÏàòÏ†ïÎê®] fetch -> fetchWithAuth ÏÇ¨Ïö©
        async function fetchMyProfile() { try { const res = await fetchWithAuth(`/users`, {}); if(res.ok) myProfile = await res.json(); } catch(e) {} }

        // 2. Quotes Logic
        // [ÏàòÏ†ïÎê®] fetch -> fetchWithAuth ÏÇ¨Ïö©
        async function fetchQuotes() {
            try {
                const res = await fetchWithAuth(`/quotes`, { method: 'GET' });
                if (!res.ok) throw new Error("Î°úÎìú Ïã§Ìå®");
                const data = await res.json();
                renderQuotes(data.content, 'quotes-list');
            } catch (err) { 
                if(err.message !== "TOKEN_EXPIRED") document.getElementById('quotes-list').innerHTML = `<div class="text-red-500 text-center p-4">ERROR: ${err.message}</div>`; 
            }
        }

        function renderQuotes(quotes, targetId) {
            const listEl = document.getElementById(targetId);
            listEl.innerHTML = '';
            if (!quotes || quotes.length === 0) { listEl.innerHTML = `<div class="text-center text-gray-500 py-10 pixel-font">NO DATA FOUND.</div>`; return; }

            quotes.forEach(q => {
                const date = new Date(q.createdAt).toLocaleDateString();
                const myLikeId = q.myLikeId || null; 
                const likeCount = q.likeCount != null ? q.likeCount : 0;
                const heartClass = myLikeId ? "fill-pink-500 text-pink-500" : "text-black";

                const item = document.createElement('div');
                item.className = 'retro-box p-0 mb-4';
                item.innerHTML = `
                    <div class="title-bar bg-white !border-b-2">
                        <span class="text-sm truncate max-w-[200px]">${q.title} (${q.pageNumber}p)</span>
                        <div class="flex gap-2"><span class="text-xs bg-gray-200 px-1 border border-black">${q.category}</span></div>
                    </div>
                    <div class="p-4 bg-[#fff]">
                        <p class="text-lg font-serif mb-4 leading-relaxed">"${q.sentence}"</p>
                        ${q.thought ? `<div class="bg-[#f0f9ff] p-2 text-sm border-l-4 border-blue-400 mb-4 text-gray-600"><span class="font-bold mr-2">üí≠ THOUGHT:</span> ${q.thought}</div>` : ''}
                        <div class="flex justify-between items-end border-t border-dashed border-gray-400 pt-3 mt-2">
                            <div class="flex flex-col"><span class="text-xs font-bold">@${q.nickname}</span><span class="text-[10px] text-gray-500">${date}</span></div>
                            <div class="flex gap-2 items-center">
                                <span class="text-xs font-bold text-gray-500">${likeCount > 0 ? likeCount : ''}</span>
                                <button onclick="toggleLike(${q.id}, ${myLikeId})" class="p-2 hover:bg-red-100 border border-transparent hover:border-black transition-all rounded-full">
                                    <i data-lucide="heart" class="w-4 h-4 ${heartClass}"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                listEl.appendChild(item);
            });
            lucide.createIcons();
        }

        // [ÏàòÏ†ïÎê®] fetch -> fetchWithAuth ÏÇ¨Ïö©
        async function toggleLike(quoteId, myLikeId) {
            try {
                let res;
                if (myLikeId) {
                    res = await fetchWithAuth(`/quotes/${quoteId}/likes/${myLikeId}`, { method: 'DELETE' });
                    if(res.ok) showToast("Ï¢ãÏïÑÏöî Ï∑®ÏÜå!");
                } else {
                    res = await fetchWithAuth(`/quotes/${quoteId}/likes`, { method: 'POST' });
                    if(res.ok) showToast("Ïù¥ Í∏ÄÏùÑ Ï¢ãÏïÑÌï©ÎãàÎã§!");
                }

                if (!res.ok) throw new Error("ÏûëÏóÖ Ïã§Ìå®");
                
                if(!document.getElementById('main-screen').classList.contains('hidden')) {
                    fetchQuotes();
                } else {
                    switchMyPageTab(currentMyPageTab);
                }

            } catch(e) { 
                if(e.message !== "TOKEN_EXPIRED") {
                    showToast("Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§."); 
                    console.error(e); 
                }
            }
        }

        // [ÏàòÏ†ïÎê®] fetch -> fetchWithAuth ÏÇ¨Ïö©
        async function createQuote(e) {
            e.preventDefault();
            const body = {
                title: document.getElementById('q-title').value, author: document.getElementById('q-author').value, category: document.getElementById('q-category').value,
                pageNumber: parseInt(document.getElementById('q-page').value) || 0, sentence: document.getElementById('q-sentence').value, thought: document.getElementById('q-thought').value, isPublic: document.getElementById('q-public').value
            };
            try {
                const res = await fetchWithAuth(`/quotes`, { method: 'POST', body: JSON.stringify(body) });
                if (!res.ok) throw new Error("ÏûëÏÑ± Ïã§Ìå®!");
                showToast("Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§!"); closeModal(); fetchQuotes();
            } catch (err) { 
                if(err.message !== "TOKEN_EXPIRED") showToast(err.message); 
            }
        }

        // 3. MyPage Logic
        async function goToMyPage() {
            document.getElementById('main-screen').classList.add('hidden'); document.getElementById('mypage-screen').classList.remove('hidden'); document.getElementById('fab-btn').classList.add('hidden');
            if(myProfile.nickname) { document.getElementById('my-nickname').innerText = myProfile.nickname; document.getElementById('my-email').innerText = myProfile.email; document.getElementById('my-role').innerText = myProfile.userRole; if(myProfile.profileUrl) document.getElementById('my-profile-img').src = myProfile.profileUrl; }
            else { await fetchMyProfile(); goToMyPage(); return; }
            switchMyPageTab('my-quotes');
        }
        
        async function switchMyPageTab(tab) {
            currentMyPageTab = tab;
            const btnMy = document.getElementById('btn-tab-my'), btnLikes = document.getElementById('btn-tab-likes'), listEl = document.getElementById('mypage-list');
            listEl.innerHTML = '<div class="text-center py-4"><i data-lucide="hourglass" class="w-6 h-6 animate-spin mx-auto"></i></div>';
            
            // [ÏàòÏ†ïÎê®] fetch -> fetchWithAuth ÏÇ¨Ïö©
            if(tab === 'my-quotes') {
                btnMy.classList.add('tab-active', 'bg-[#fff1e6]'); btnMy.classList.remove('bg-gray-300'); btnLikes.classList.remove('tab-active', 'bg-[#fff1e6]'); btnLikes.classList.add('bg-gray-300');
                try { const res = await fetchWithAuth(`/quotes`, { method: 'GET' }); const data = await res.json(); const myQuotes = data.content.filter(q => q.nickname === myProfile.nickname); renderQuotes(myQuotes, 'mypage-list'); } 
                catch(e) { if(e.message !== "TOKEN_EXPIRED") listEl.innerHTML = "Î°úÎìú Ïã§Ìå®"; }
            } else {
                btnLikes.classList.add('tab-active', 'bg-[#fff1e6]'); btnLikes.classList.remove('bg-gray-300'); btnMy.classList.remove('tab-active', 'bg-[#fff1e6]'); btnMy.classList.add('bg-gray-300');
                try { const res = await fetchWithAuth(`/likes`, { method: 'GET' }); const data = await res.json(); renderLikedQuotes(data.content); } 
                catch(e) { if(e.message !== "TOKEN_EXPIRED") listEl.innerHTML = "Î°úÎìú Ïã§Ìå®"; }
            }
        }

        function renderLikedQuotes(likes) {
            const listEl = document.getElementById('mypage-list'); listEl.innerHTML = '';
            if (!likes || likes.length === 0) { listEl.innerHTML = `<div class="text-center text-gray-500 py-10 pixel-font">NO LIKES YET.</div>`; return; }
            
            likes.forEach(item => { 
                const date = new Date(item.createdAt).toLocaleDateString();
                const likeCount = item.likeCount != null ? item.likeCount : 0; 
                const el = document.createElement('div'); 
                el.className = 'retro-box p-0 mb-4'; 
                
                el.innerHTML = `
                    <div class="title-bar bg-white !border-b-2">
                        <span class="text-sm truncate max-w-[200px]">${item.title} (${item.pageNumber}p)</span>
                        <div class="flex gap-2"><span class="text-xs bg-gray-200 px-1 border border-black">${item.category}</span></div>
                    </div>
                    <div class="p-4 bg-[#fff]">
                        <p class="text-lg font-serif mb-4 leading-relaxed">"${item.sentence}"</p>
                        ${item.thought ? `<div class="bg-[#f0f9ff] p-2 text-sm border-l-4 border-blue-400 mb-4 text-gray-600"><span class="font-bold mr-2">üí≠ THOUGHT:</span> ${item.thought}</div>` : ''}
                        <div class="flex justify-between items-end border-t border-dashed border-gray-400 pt-3 mt-2">
                            <div class="flex flex-col"><span class="text-xs font-bold">${item.author}</span><span class="text-[10px] text-gray-500">${date}</span></div>
                            <div class="flex gap-2 items-center">
                                <span class="text-xs font-bold text-gray-500">${likeCount > 0 ? likeCount : ''}</span>
                                <button onclick="toggleLike(${item.quoteId}, ${item.id})" class="p-2 hover:bg-red-100 border border-transparent hover:border-black transition-all rounded-full">
                                    <i data-lucide="heart" class="w-4 h-4 fill-pink-500 text-pink-500"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                `; 
                listEl.appendChild(el); 
            });
            lucide.createIcons();
        }

        function showAuthScreen() { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('main-screen').classList.add('hidden'); document.getElementById('mypage-screen').classList.add('hidden'); document.getElementById('fab-btn').classList.add('hidden'); }
        function showMainScreen() { document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('mypage-screen').classList.add('hidden'); document.getElementById('main-screen').classList.remove('hidden'); document.getElementById('fab-btn').classList.remove('hidden'); fetchQuotes(); }
        function openModal() { document.getElementById('modal-overlay').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); document.getElementById('quote-form').reset(); }
        function showToast(msg) { const toast = document.getElementById('toast'); toast.innerText = msg; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 3000); }
    </script>
</body>
</html>