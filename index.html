<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Retro Quotes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://cdn.jsdelivr.net/npm/galmuri/dist/galmuri.css');

        :root { 
            --bg-color: #e0e7ff; 
            --window-bg: #fff1e6; 
            --border-color: #2d2d2d; 
            --accent-blue: #93c5fd; 
            --accent-red: #fca5a5; 
            --accent-yellow: #fbbf24; 
        }

        body { 
            font-family: 'Galmuri9', sans-serif; 
            background-color: var(--bg-color); 
            background-image: linear-gradient(var(--accent-blue) 1px, transparent 1px), linear-gradient(90deg, var(--accent-blue) 1px, transparent 1px); 
            background-size: 20px 20px; 
            color: var(--border-color); 
            overflow-x: hidden; 
        }

        .retro-box { 
            background-color: var(--window-bg); 
            border: 3px solid var(--border-color); 
            box-shadow: 4px 4px 0px rgba(0,0,0,0.8); 
            border-radius: 0px; 
            transition: transform 0.1s, box-shadow 0.1s; 
        }

        .retro-input { 
            width: 100%; 
            background: #fff; 
            border: 2px solid var(--border-color); 
            padding: 8px; 
            font-family: 'Galmuri9', monospace; 
            font-size: 1rem; 
            outline: none; 
            box-shadow: inset 2px 2px 0px rgba(0,0,0,0.1), inset -1px -1px 0px rgba(255,255,255,0.5);
        }
        .retro-input:focus { 
            background: #fdfce0; 
            box-shadow: inset 2px 2px 0px rgba(0,0,0,0.2); 
        }

        /* ì—ëŸ¬ ë°œìƒ ì‹œ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .input-error {
            border-color: #ef4444 !important; /* red-500 */
            background-color: #fef2f2 !important; /* red-50 */
        }

        .retro-btn { 
            background-color: var(--accent-yellow); 
            border: 2px solid var(--border-color); 
            padding: 8px 16px; 
            font-weight: bold; 
            text-transform: uppercase; 
            cursor: pointer; 
            box-shadow: 3px 3px 0px var(--border-color); 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 5px;
            font-size: 0.9rem;
            transition: all 0.1s;
        }
        .retro-btn:active { 
            transform: translate(3px, 3px); 
            box-shadow: 0px 0px 0px var(--border-color); 
        }
        .retro-btn.primary { background-color: var(--accent-yellow); color: black; }
        .retro-btn.danger { background-color: var(--accent-red); color: black; }
        .retro-btn.success { background-color: #86efac; color: black; }
        .retro-btn.neutral { background-color: #e5e7eb; color: black; }

        .title-bar { 
            background: linear-gradient(90deg, var(--accent-blue), #bfdbfe);
            border-bottom: 2px solid var(--border-color); 
            padding: 6px 10px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            font-family: 'Galmuri9', monospace; 
            font-size: 1.1rem; 
            color: var(--border-color); 
            font-weight: bold; 
        }

        .pixel-font { font-family: 'Galmuri9', monospace; }
        .tab-active { background-color: var(--window-bg) !important; border-bottom: none !important; position: relative; top: 2px; z-index: 10; }
        @keyframes flip { 0%, 100% { transform: rotate(0deg); } 50% { transform: rotate(180deg); } }
        .loading-icon { animation: flip 2s infinite ease-in-out; }
        .app-container { max-width: 500px; margin: 0 auto; min-height: 100vh; padding: 20px; padding-bottom: 80px; }
        .cursor-pointer { cursor: pointer; }
        ::-webkit-scrollbar { width: 10px; }
        ::-webkit-scrollbar-track { background: #e5e7eb; border-left: 2px solid #2d2d2d; }
        ::-webkit-scrollbar-thumb { background: #2d2d2d; border: 1px solid #fff; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
</head>
<body>
    <div id="app" class="app-container">
        <div id="auth-screen" class="flex flex-col gap-6 justify-center min-h-[80vh]">
            <div class="retro-box p-0">
                <div class="title-bar"><span>SYSTEM_LOGIN.EXE</span><div class="flex gap-1"><div class="w-3 h-3 border border-black bg-white"></div><div class="w-3 h-3 border border-black bg-white"></div></div></div>
                <div class="p-6 flex flex-col gap-4 bg-[#fdfbf7]">
                    <div class="text-center mb-4">
                        <h1 class="text-4xl font-bold pixel-font mb-2">RETRO QUOTES</h1>
                        <p class="text-xs text-gray-500 tracking-tighter">YOUR DAILY INSPIRATION STORAGE</p>
                    </div>
                    <div class="flex gap-2 mb-2">
                        <button onclick="switchAuthMode('login')" id="tab-login" class="retro-btn flex-1 bg-white">ë¡œê·¸ì¸</button>
                        <button onclick="switchAuthMode('signup')" id="tab-signup" class="retro-btn flex-1 bg-gray-200">ê°€ì…</button>
                    </div>
                    <form id="auth-form" onsubmit="handleAuth(event)">
                        <div class="flex flex-col gap-4">
                            <div>
                                <label class="text-[10px] font-bold mb-1 block">EMAIL</label>
                                <input type="email" id="email" class="retro-input" required>
                            </div>
                            
                            <div>
                                <label class="text-[10px] font-bold mb-1 block">PASSWORD</label>
                                <input type="password" id="password" class="retro-input" required placeholder="8ì ì´ìƒ, ëŒ€/ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì">
                                <p id="pw-rule-error" class="text-[10px] text-red-500 mt-1 hidden">
                                    * 8ì ì´ìƒ, ëŒ€ë¬¸ì, ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì(!@#$%^&*)ë¥¼ ëª¨ë‘ í¬í•¨í•´ì•¼ í•©ë‹ˆë‹¤.
                                </p>
                            </div>

                            <div id="signup-fields" class="hidden flex flex-col gap-4">
                                <div>
                                    <label class="text-[10px] font-bold mb-1 block">CONFIRM PASSWORD</label>
                                    <input type="password" id="password-confirm" class="retro-input" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                                    <p id="pw-match-error" class="text-[10px] text-red-500 mt-1 hidden">
                                        * ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                                    </p>
                                </div>

                                <div>
                                    <label class="text-[10px] font-bold mb-1 block">NICKNAME</label>
                                    <input type="text" id="nickname" class="retro-input">
                                </div>
                                <div>
                                    <label class="text-[10px] font-bold mb-1 block">PROFILE URL</label>
                                    <input type="text" id="profileUrl" class="retro-input">
                                </div>
                            </div>
                            <button type="submit" class="retro-btn primary w-full mt-4 h-12 text-lg">ENTER SYSTEM</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div id="main-screen" class="hidden">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold pixel-font bg-white border-2 border-black px-3 py-1 shadow-[3px_3px_0px_rgba(0,0,0,1)]">QUOTES_FEED</h2>
                <button onclick="goToMyPage()" class="retro-btn success text-xs px-3 py-1">MY PAGE</button>
            </header>
            <div class="mb-6 retro-box p-2 flex gap-2 bg-white items-center">
                <i data-lucide="search" class="w-5 h-5 ml-1"></i>
                <input type="text" placeholder="Search quotes..." class="bg-transparent outline-none w-full font-mono text-sm ml-2">
            </div>
            <div id="quotes-list" class="flex flex-col gap-6"></div>
        </div>

        <div id="mypage-screen" class="hidden">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold pixel-font bg-white border-2 border-black px-3 py-1 shadow-[3px_3px_0px_rgba(0,0,0,1)]">MY_PAGE</h2>
                <div class="flex gap-2"><button onclick="showMainScreen()" class="retro-btn neutral text-xs px-2 py-1">HOME</button><button onclick="logout()" class="retro-btn danger text-xs px-2 py-1">LOGOUT</button></div>
            </header>
            <div class="retro-box p-4 mb-6 flex items-center gap-4 bg-[#fdfbf7]">
                <div class="w-20 h-20 bg-gray-200 border-2 border-black overflow-hidden relative shadow-[2px_2px_0px_rgba(0,0,0,0.5)]">
                     <img id="my-profile-img" src="" onerror="this.src='https://via.placeholder.com/150'" class="w-full h-full object-cover hidden">
                     <i data-lucide="user" class="w-8 h-8 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div>
                    <h3 id="my-nickname" class="text-xl font-bold pixel-font mb-1">LOADING...</h3>
                    <p id="my-email" class="text-xs text-gray-500 font-mono mb-2">user@email.com</p>
                    <span id="my-role" class="text-[10px] bg-blue-100 px-2 py-0.5 border border-black inline-block font-bold">USER</span>
                </div>
            </div>
            <div class="flex border-b-2 border-black mb-4 px-2 gap-2">
                <button onclick="switchMyPageTab('my-quotes')" id="btn-tab-my" class="retro-btn bg-gray-300 border-b-0 rounded-b-none px-4 py-2 text-sm shadow-none">ë‚´ê°€ ì“´ ê¸€</button>
                <button onclick="switchMyPageTab('likes')" id="btn-tab-likes" class="retro-btn bg-gray-300 border-b-0 rounded-b-none px-4 py-2 text-sm shadow-none">ì¢‹ì•„ìš”</button>
            </div>
            <div id="mypage-list" class="flex flex-col gap-4"></div>
        </div>

        <div id="user-profile-screen" class="hidden">
            <header class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold pixel-font bg-white border-2 border-black px-3 py-1 shadow-[3px_3px_0px_rgba(0,0,0,1)]">USER_PROFILE</h2>
                <button onclick="showMainScreen()" class="retro-btn neutral text-xs px-2 py-1">HOME</button>
            </header>
            <div class="retro-box p-4 mb-6 flex items-center gap-4 bg-[#fdfbf7]">
                <div class="w-20 h-20 bg-gray-200 border-2 border-black overflow-hidden relative shadow-[2px_2px_0px_rgba(0,0,0,0.5)]">
                     <img id="other-profile-img" src="" onerror="this.src='https://via.placeholder.com/150'" class="w-full h-full object-cover hidden">
                     <i data-lucide="user" class="w-8 h-8 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-gray-400"></i>
                </div>
                <div>
                    <h3 id="other-nickname" class="text-xl font-bold pixel-font mb-1">LOADING...</h3>
                    <p id="other-email" class="text-xs text-gray-500 font-mono">...</p>
                    <span id="other-role" class="text-[10px] bg-blue-100 px-2 py-0.5 border border-black mt-2 inline-block font-bold">USER</span>
                </div>
            </div>
            <div class="border-b-2 border-black mb-4 px-2">
                <span class="inline-block bg-[#fff1e6] border-2 border-b-0 border-black px-4 py-2 text-sm font-bold relative top-[2px]">ì‘ì„±í•œ ê¸€</span>
            </div>
            <div id="other-user-quotes-list" class="flex flex-col gap-4"></div>
        </div>

        <button onclick="openModal()" id="fab-btn" class="hidden fixed bottom-6 right-6 w-14 h-14 bg-[#86efac] border-2 border-black shadow-[4px_4px_0px_rgba(0,0,0,1)] flex items-center justify-center hover:translate-y-1 transition-all z-50 active:shadow-none active:translate-y-[4px]"><i data-lucide="plus" class="w-8 h-8 text-black"></i></button>
    </div>

    <div id="modal-overlay" class="fixed inset-0 bg-black/50 hidden z-[100] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="retro-box w-full max-w-md bg-[#fff1e6] animate-bounce-in relative">
            <div class="title-bar bg-[#fca5a5]"><span>NEW_QUOTE.TXT</span><button onclick="closeModal()" class="hover:bg-red-400 p-1 border border-transparent hover:border-black transition-colors"><i data-lucide="x" class="w-4 h-4"></i></button></div>
            <form id="quote-form" onsubmit="createQuote(event)" class="p-5 flex flex-col gap-4">
                <div>
                    <label class="text-[10px] font-bold mb-1 block">TITLE (BOOK)</label>
                    <div class="flex gap-2">
                        <input type="text" id="q-title" class="retro-input" placeholder="ì±… ì œëª©" required>
                        <button type="button" onclick="openBookSearchModal()" class="retro-btn neutral whitespace-nowrap px-3"><i data-lucide="search" class="w-4 h-4"></i></button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="text-[10px] font-bold mb-1 block">AUTHOR</label><input type="text" id="q-author" class="retro-input" placeholder="ì €ì"></div>
                    <div><label class="text-[10px] font-bold mb-1 block">PAGE</label><input type="number" id="q-page" class="retro-input" placeholder="0" min="0"></div>
                </div>
                <div><label class="text-[10px] font-bold mb-1 block">SENTENCE</label><textarea id="q-sentence" rows="3" class="retro-input" placeholder="ì—¬ê¸°ì— ë¬¸ì¥ì„ ì…ë ¥í•˜ì„¸ìš”..." required></textarea></div>
                <div><label class="text-[10px] font-bold mb-1 block">THOUGHT</label><textarea id="q-thought" rows="2" class="retro-input" placeholder="ë‹¹ì‹ ì˜ ìƒê°ì€?"></textarea></div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="text-[10px] font-bold mb-1 block">CATEGORY</label>
                        <select id="q-category" class="retro-input"><option value="NOVEL">ì†Œì„¤</option><option value="POETRY">ì‹œ</option><option value="SCENARIO">ì‹œë‚˜ë¦¬ì˜¤</option><option value="ESSAY">ìˆ˜í•„</option><option value="PLAY">í¬ê³¡</option><option value="AUTOBIOGRAPHY">ìì„œì „</option><option value="MEMOIR">íšŒê³ ë¡</option><option value="CHILDREN_LITERATURE">ì•„ë™ë¬¸í•™</option><option value="CRITICISM">ë¬¸í•™ë¹„í‰</option></select>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold mb-1 block">PUBLIC</label>
                        <select id="q-public" class="retro-input"><option value="PUBLIC">ê³µê°œ</option><option value="PRIVATE">ë¹„ê³µê°œ</option></select>
                    </div>
                </div>
                <div class="flex gap-2 mt-4 pt-2 border-t-2 border-dashed border-gray-300"><button type="button" onclick="closeModal()" class="retro-btn w-1/2">CANCEL</button><button type="submit" class="retro-btn success w-1/2">SAVE</button></div>
            </form>
        </div>
    </div>

    <div id="book-search-overlay" class="fixed inset-0 bg-black/60 hidden z-[150] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="retro-box w-full max-w-lg bg-[#e0e7ff] animate-bounce-in relative flex flex-col h-[80vh]">
            <div class="title-bar bg-[#93c5fd]"><span>SEARCH_BOOK.EXE</span><button onclick="closeBookSearchModal()" class="hover:bg-blue-400 p-1 border border-transparent hover:border-black"><i data-lucide="x" class="w-4 h-4"></i></button></div>
            <div class="p-4 flex flex-col gap-4 flex-1 overflow-hidden">
                <div class="flex gap-2">
                    <input type="text" id="book-search-input" class="retro-input" placeholder="ì±… ì œëª©ì„ ê²€ìƒ‰í•˜ì„¸ìš”..." onkeydown="if(event.key === 'Enter') searchBooks(1)">
                    <button onclick="searchBooks(1)" class="retro-btn primary">ê²€ìƒ‰</button>
                </div>
                <div id="book-list" class="flex-1 overflow-y-auto border-2 border-black bg-white p-2 space-y-2 box-inner-shadow">
                    <div class="text-center text-gray-500 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>
                </div>
                <div class="flex justify-between items-center bg-gray-200 p-2 border-2 border-black">
                    <button onclick="changeBookPage(-1)" id="btn-prev-page" class="retro-btn neutral text-xs" disabled>PREV</button>
                    <span id="current-page-display" class="font-bold pixel-font">PAGE 1</span>
                    <button onclick="changeBookPage(1)" id="btn-next-page" class="retro-btn neutral text-xs" disabled>NEXT</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed top-5 left-1/2 transform -translate-x-1/2 bg-black text-white px-6 py-3 border-2 border-white shadow-[4px_4px_0px_rgba(255,255,255,1)] hidden z-[200] pixel-font text-center">MESSAGE HERE</div>

    <script>
        const API_BASE_URL = "http://localhost:8080"; 
        let currentAuthMode = 'login', currentMyPageTab = 'my-quotes', token = localStorage.getItem('accessToken'), myProfile = {};
        let currentViewingUserId = null, currentBookPage = 1, currentBookQuery = "", isBookEnd = false;

        const PASSWORD_REGEX = /^(?=.*[A-Z])(?=.*[a-z])(?=.*\d)(?=.*[!@#$%^&*])[a-zA-Z0-9!@#$%^&*]{8,}$/;

        document.addEventListener('DOMContentLoaded', () => { lucide.createIcons(); checkAuth(); });

        async function fetchWithAuth(url, options = {}) {
            const headers = { 'Content-Type': 'application/json', 'Authorization': token, ...options.headers };
            try {
                const response = await fetch(`${API_BASE_URL}${url}`, { ...options, headers });
                if (response.status === 401) {
                    const errorText = await response.clone().text(); 
                    if (errorText.toLowerCase().includes("expired") || errorText.includes("ë§Œë£Œ") || errorText.toLowerCase().includes("invalid") || errorText.includes("ìœ íš¨í•˜ì§€")) {
                        showToast("âš ï¸ ì¸ì¦ ì„¸ì…˜ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                        setTimeout(() => { logout(); }, 2000);
                        throw new Error("TOKEN_EXPIRED");
                    } else {
                        throw new Error("UNAUTHORIZED_ACTION"); 
                    }
                }
                return response;
            } catch (err) { throw err; }
        }

        function checkAuth() { 
            if (token) { 
                fetchMyProfile().then(() => { showMainScreen(); });
            } else { 
                showAuthScreen(); 
            } 
        }

        function switchAuthMode(mode) {
            currentAuthMode = mode;
            const signup = document.getElementById('signup-fields'), tabLogin = document.getElementById('tab-login'), tabSignup = document.getElementById('tab-signup'), btn = document.querySelector('#auth-form button');
            const pwRule = document.getElementById('pw-rule-error'), pwMatch = document.getElementById('pw-match-error');
            const pwInput = document.getElementById('password'), pwConfirm = document.getElementById('password-confirm');

            pwRule.classList.add('hidden');
            pwMatch.classList.add('hidden');
            pwInput.classList.remove('input-error');
            pwConfirm.classList.remove('input-error');
            pwInput.value = '';
            pwConfirm.value = '';

            if (mode === 'signup') { 
                signup.classList.remove('hidden'); 
                tabSignup.classList.add('bg-white'); tabSignup.classList.remove('bg-gray-200'); 
                tabLogin.classList.remove('bg-white'); tabLogin.classList.add('bg-gray-200'); 
                btn.innerText = "REGISTER USER"; 
            } else { 
                signup.classList.add('hidden'); 
                tabLogin.classList.add('bg-white'); tabLogin.classList.remove('bg-gray-200'); 
                tabSignup.classList.remove('bg-white'); tabSignup.classList.add('bg-gray-200'); 
                btn.innerText = "ENTER SYSTEM"; 
            }
        }

        function validateSignup() {
            const pw = document.getElementById('password').value;
            const pwConfirm = document.getElementById('password-confirm').value;
            const pwRuleError = document.getElementById('pw-rule-error');
            const pwMatchError = document.getElementById('pw-match-error');
            const pwInput = document.getElementById('password');
            const pwConfirmInput = document.getElementById('password-confirm');

            let isValid = true;

            if (!PASSWORD_REGEX.test(pw)) {
                pwRuleError.classList.remove('hidden');
                pwInput.classList.add('input-error');
                isValid = false;
            } else {
                pwRuleError.classList.add('hidden');
                pwInput.classList.remove('input-error');
            }

            if (pw !== pwConfirm) {
                pwMatchError.classList.remove('hidden');
                pwConfirmInput.classList.add('input-error');
                isValid = false;
            } else {
                pwMatchError.classList.add('hidden');
                pwConfirmInput.classList.remove('input-error');
            }

            return isValid;
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value, password = document.getElementById('password').value, endpoint = currentAuthMode === 'login' ? '/signin' : '/signup';
            const body = { email, password };
            
            if (currentAuthMode === 'signup') { 
                if (!validateSignup()) {
                    showToast("ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    return; 
                }

                body.nickname = document.getElementById('nickname').value; 
                body.profileUrl = document.getElementById('profileUrl').value; 
                body.userRole = 'USER'; 
            }

            try {
                const res = await fetch(`${API_BASE_URL}${endpoint}`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                
                if (!res.ok) {
                    let errMsg = 'ì¸ì¦ ì‹¤íŒ¨!';
                    try {
                        const errData = await res.json();
                        errMsg = errData.message || 'ì¸ì¦ ì‹¤íŒ¨!';
                    } catch(e) {}
                    throw new Error(errMsg);
                }

                const data = await res.json();
                if (currentAuthMode === 'signup') { showToast("íšŒì›ê°€ì… ì™„ë£Œ! ë¡œê·¸ì¸í•˜ì„¸ìš”."); switchAuthMode('login'); } 
                else { token = data.token; localStorage.setItem('accessToken', token); showToast("ì‹œìŠ¤í…œ ì ‘ì† ì„±ê³µ"); checkAuth(); }
            } catch (err) { showToast(err.message); }
        }

        function logout() { localStorage.clear(); token = null; location.reload(); }
        async function fetchMyProfile() { try { const res = await fetchWithAuth(`/users`, {}); if(res.ok) myProfile = await res.json(); return true; } catch(e) { if (e.message !== "TOKEN_EXPIRED") console.error(e); } return false; }

        async function fetchQuotes() {
            try {
                const res = await fetchWithAuth(`/quotes`, { method: 'GET' });
                if (!res.ok) throw new Error("ë¡œë“œ ì‹¤íŒ¨");
                const data = await res.json();
                renderQuotes(data.content, 'quotes-list');
            } catch (err) { if(err.message !== "TOKEN_EXPIRED") document.getElementById('quotes-list').innerHTML = `<div class="text-red-500 text-center p-4">ERROR: ${err.message}</div>`; }
        }

        function renderQuotes(quotes, targetId) {
            const listEl = document.getElementById(targetId);
            listEl.innerHTML = '';
            if (!quotes || quotes.length === 0) { listEl.innerHTML = `<div class="text-center text-gray-500 py-10 pixel-font">NO DATA FOUND.</div>`; return; }

            quotes.forEach(q => {
                const date = new Date(q.createdAt).toLocaleDateString();
                const myLikeId = q.myLikeId || null; 
                const likeCount = q.likeCount != null ? q.likeCount : 0;
                const heartClass = myLikeId ? "fill-pink-500 text-pink-500" : "text-black";
                const isMyQuote = (myProfile.id === q.userId);
                
                const deleteButton = isMyQuote ? `<button onclick="deleteQuote(${q.id})" class="p-2 hover:bg-gray-200 border border-transparent hover:border-black transition-all rounded-full ml-1" title="ì‚­ì œ"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>` : '';
                
                let publicStatusBadge = '';
                if (targetId === 'mypage-list' && isMyQuote && q.isPublic) {
                    const isPrivate = q.isPublic === 'PRIVATE';
                    publicStatusBadge = isPrivate 
                        ? `<span class="text-[10px] bg-red-200 text-red-800 px-1 border border-red-800 flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i>PRIVATE</span>` 
                        : `<span class="text-[10px] bg-blue-200 text-blue-800 px-1 border border-blue-800 flex items-center gap-1"><i data-lucide="globe" class="w-3 h-3"></i>PUBLIC</span>`;
                }

                const item = document.createElement('div');
                item.className = 'retro-box p-0 mb-4';
                item.innerHTML = `
                    <div class="title-bar bg-white !border-b-2">
                        <div class="flex items-center min-w-0 flex-1 mr-2"><span class="text-sm truncate font-bold" title="${q.title}">${q.title}</span><span class="text-xs whitespace-nowrap flex-shrink-0 ml-1">(${q.pageNumber}p)</span></div>
                        <div class="flex gap-2 flex-shrink-0 items-center">
                            ${publicStatusBadge}
                            <span class="text-[10px] bg-gray-200 px-1 border border-black">${q.category}</span>
                        </div>
                    </div>
                    <div class="p-4 bg-[#fff]">
                        <p class="text-lg mb-4 leading-relaxed tracking-wide">"${q.sentence}"</p>
                        ${q.thought ? `<div class="bg-[#f0f9ff] p-3 text-sm border-2 border-dashed border-blue-300 mb-4 text-gray-600"><span class="font-bold mr-2 text-blue-500">ğŸ’­ THOUGHT:</span> ${q.thought}</div>` : ''}
                        <div class="flex justify-between items-end border-t-2 border-dotted border-gray-300 pt-3 mt-2">
                            <div class="flex flex-col"><span onclick="goToUserProfile(${q.userId})" class="text-xs font-bold cursor-pointer hover:underline text-blue-800">@${q.nickname}</span><span class="text-[10px] text-gray-500 font-mono">${date}</span></div>
                            <div class="flex gap-1 items-center">
                                <span class="text-xs font-bold text-gray-500 pixel-font mr-1">${likeCount > 0 ? likeCount : ''}</span>
                                <button onclick="toggleLike(${q.id}, ${myLikeId})" class="p-2 hover:bg-red-100 border border-transparent hover:border-black transition-all rounded-full active:scale-90"><i data-lucide="heart" class="w-4 h-4 ${heartClass}"></i></button>
                                ${deleteButton}
                            </div>
                        </div>
                    </div>`;
                listEl.appendChild(item);
            });
            lucide.createIcons();
        }

        async function deleteQuote(quoteId) {
            if (!confirm("ì •ë§ ì´ ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            try {
                const res = await fetchWithAuth(`/quotes/${quoteId}`, { method: 'DELETE' });
                if (res.ok) {
                    showToast("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                    if(!document.getElementById('main-screen').classList.contains('hidden')) fetchQuotes();
                    else if (!document.getElementById('mypage-screen').classList.contains('hidden')) switchMyPageTab(currentMyPageTab);
                } else { throw new Error("ì‚­ì œ ì‹¤íŒ¨"); }
            } catch(e) {
                if (e.message === "UNAUTHORIZED_ACTION") showToast("â›” ë³¸ì¸ì˜ ê²Œì‹œê¸€ë§Œ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                else if (e.message !== "TOKEN_EXPIRED") showToast("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        async function toggleLike(quoteId, myLikeId) {
            try {
                let res;
                if (myLikeId) {
                    res = await fetchWithAuth(`/quotes/${quoteId}/likes/${myLikeId}`, { method: 'DELETE' });
                    if(res.ok) showToast("ì¢‹ì•„ìš” ì·¨ì†Œ!");
                } else {
                    res = await fetchWithAuth(`/quotes/${quoteId}/likes`, { method: 'POST' });
                    if(res.ok) showToast("ì´ ê¸€ì„ ì¢‹ì•„í•©ë‹ˆë‹¤!");
                }
                if (!res.ok) { const errText = await res.text(); throw new Error(errText || "ì‘ì—… ì‹¤íŒ¨"); }
                if(!document.getElementById('main-screen').classList.contains('hidden')) fetchQuotes();
                else if (!document.getElementById('mypage-screen').classList.contains('hidden')) switchMyPageTab(currentMyPageTab);
                else if (!document.getElementById('user-profile-screen').classList.contains('hidden') && currentViewingUserId) loadOtherUserQuotes(currentViewingUserId);
            } catch(e) { if(e.message !== "TOKEN_EXPIRED") showToast(e.message.length < 50 ? e.message : "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); }
        }

        async function createQuote(e) {
            e.preventDefault();
            const pageInput = document.getElementById('q-page').value;
            let pageNumber = parseInt(pageInput) || 0;

            if (pageNumber < 0) {
                showToast("í˜ì´ì§€ ë²ˆí˜¸ëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
                return;
            }

            const body = {
                title: document.getElementById('q-title').value, author: document.getElementById('q-author').value, category: document.getElementById('q-category').value,
                pageNumber: pageNumber, sentence: document.getElementById('q-sentence').value, thought: document.getElementById('q-thought').value, isPublic: document.getElementById('q-public').value
            };
            try {
                const res = await fetchWithAuth(`/quotes`, { method: 'POST', body: JSON.stringify(body) });
                if (!res.ok) throw new Error("ì‘ì„± ì‹¤íŒ¨!");
                showToast("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"); closeModal(); fetchQuotes();
            } catch (err) { if(err.message !== "TOKEN_EXPIRED") showToast(err.message); }
        }

        function openBookSearchModal() {
            document.getElementById('book-search-overlay').classList.remove('hidden');
            currentBookPage = 1; currentBookQuery = "";
            document.getElementById('book-search-input').value = "";
            document.getElementById('book-list').innerHTML = '<div class="text-center text-gray-500 py-10">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.</div>';
            updateBookPaginationButtons();
        }
        function closeBookSearchModal() { document.getElementById('book-search-overlay').classList.add('hidden'); }
        async function searchBooks(page) {
            const query = document.getElementById('book-search-input').value;
            if (!query) { showToast("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”."); return; }
            currentBookQuery = query; currentBookPage = page;
            const listEl = document.getElementById('book-list');
            listEl.innerHTML = '<div class="text-center py-10"><i data-lucide="hourglass" class="w-8 h-8 animate-spin mx-auto"></i></div>';
            try {
                const params = new URLSearchParams({ query: currentBookQuery, page: currentBookPage.toString() });
                const res = await fetchWithAuth(`/books?${params.toString()}`, { method: 'GET' });
                if (!res.ok) throw new Error("ê²€ìƒ‰ ì‹¤íŒ¨");
                const data = await res.json();
                isBookEnd = data.meta.is_end; renderBooks(data.documents); updateBookPaginationButtons();
            } catch(e) { if(e.message !== "TOKEN_EXPIRED") listEl.innerHTML = '<div class="text-center text-red-500 py-10">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>'; }
        }
        function renderBooks(books) {
            const listEl = document.getElementById('book-list'); listEl.innerHTML = '';
            if (!books || books.length === 0) { listEl.innerHTML = '<div class="text-center text-gray-500 py-10">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }
            books.forEach(book => {
                const authors = book.authors.join(', '); const thumbnail = book.thumbnail ? book.thumbnail : 'https://via.placeholder.com/100x150?text=No+Img';
                const bookItem = document.createElement('div');
                bookItem.className = 'flex gap-3 p-2 border-b-2 border-dashed border-gray-300 hover:bg-yellow-50 cursor-pointer transition-colors active:bg-yellow-100';
                bookItem.onclick = () => selectBook(book.title, authors);
                bookItem.innerHTML = `<img src="${thumbnail}" class="w-16 h-20 object-cover border-2 border-black shadow-[2px_2px_0px_rgba(0,0,0,0.5)]"><div class="flex flex-col justify-center"><span class="font-bold text-sm line-clamp-1">${book.title}</span><span class="text-xs text-gray-600 line-clamp-1">${authors}</span><span class="text-[10px] text-gray-400 mt-1 font-mono">${book.publisher}</span></div>`;
                listEl.appendChild(bookItem);
            });
        }
        function selectBook(title, author) { document.getElementById('q-title').value = title; document.getElementById('q-author').value = author; closeBookSearchModal(); showToast("ì±… ì •ë³´ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤."); }
        function changeBookPage(delta) { const newPage = currentBookPage + delta; if (newPage < 1) return; searchBooks(newPage); }
        function updateBookPaginationButtons() {
            document.getElementById('current-page-display').innerText = `PAGE ${currentBookPage}`;
            document.getElementById('btn-prev-page').disabled = (currentBookPage <= 1); document.getElementById('btn-next-page').disabled = isBookEnd;
            const prevBtn = document.getElementById('btn-prev-page'), nextBtn = document.getElementById('btn-next-page');
            prevBtn.style.opacity = prevBtn.disabled ? '0.5' : '1'; nextBtn.style.opacity = nextBtn.disabled ? '0.5' : '1';
        }
        
        async function goToUserProfile(userId) {
            currentViewingUserId = userId; 
            document.getElementById('main-screen').classList.add('hidden'); 
            document.getElementById('mypage-screen').classList.add('hidden'); 
            document.getElementById('user-profile-screen').classList.remove('hidden'); 
            
            // [ìˆ˜ì •] íƒ€ ìœ ì € í”„ë¡œí•„ì—ì„œë„ ê¸€ì“°ê¸° ë²„íŠ¼ ë…¸ì¶œ (hidden í´ë˜ìŠ¤ ì œê±°)
            document.getElementById('fab-btn').classList.remove('hidden');

            const listEl = document.getElementById('other-user-quotes-list'); 
            listEl.innerHTML = '<div class="text-center py-4"><i data-lucide="hourglass" class="w-6 h-6 animate-spin mx-auto"></i></div>';
            try {
                const userRes = await fetchWithAuth(`/users/${userId}`, { method: 'GET' });
                if(!userRes.ok) throw new Error("ìœ ì € ì •ë³´ ë¡œë“œ ì‹¤íŒ¨");
                const userInfo = await userRes.json();
                document.getElementById('other-nickname').innerText = userInfo.nickname; document.getElementById('other-email').innerText = userInfo.email; document.getElementById('other-role').innerText = userInfo.userRole;
                const img = document.getElementById('other-profile-img'); if(userInfo.profileUrl) { img.src = userInfo.profileUrl; img.classList.remove('hidden'); } else { img.classList.add('hidden'); }
                await loadOtherUserQuotes(userId);
            } catch(e) { if(e.message !== "TOKEN_EXPIRED") { showToast("ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); listEl.innerHTML = "ë¡œë“œ ì‹¤íŒ¨"; } }
        }
        async function loadOtherUserQuotes(userId) {
            try {
                const quotesRes = await fetchWithAuth(`/users/${userId}/quotes`, { method: 'GET' });
                if(!quotesRes.ok) throw new Error("ê¸€ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨");
                const quotesData = await quotesRes.json();
                renderQuotes(quotesData.content, 'other-user-quotes-list');
            } catch(e) { console.error(e); }
        }

        async function switchMyPageTab(tab) {
            currentMyPageTab = tab;
            const btnMy = document.getElementById('btn-tab-my'), btnLikes = document.getElementById('btn-tab-likes'), listEl = document.getElementById('mypage-list');
            listEl.innerHTML = '<div class="text-center py-4"><i data-lucide="hourglass" class="w-6 h-6 animate-spin mx-auto"></i></div>';
            
            if(tab === 'my-quotes') {
                btnMy.classList.add('tab-active', 'bg-[#fff1e6]'); btnMy.classList.remove('bg-gray-300'); 
                btnLikes.classList.remove('tab-active', 'bg-[#fff1e6]'); btnLikes.classList.add('bg-gray-300');
                try { 
                    const res = await fetchWithAuth(`/users/me/quotes`, { method: 'GET' }); 
                    const data = await res.json(); 
                    renderQuotes(data.content, 'mypage-list'); 
                } catch(e) { if(e.message !== "TOKEN_EXPIRED") listEl.innerHTML = "ë¡œë“œ ì‹¤íŒ¨"; }
            } else {
                btnLikes.classList.add('tab-active', 'bg-[#fff1e6]'); btnLikes.classList.remove('bg-gray-300'); 
                btnMy.classList.remove('tab-active', 'bg-[#fff1e6]'); btnMy.classList.add('bg-gray-300');
                try { 
                    const res = await fetchWithAuth(`/likes`, { method: 'GET' }); 
                    const data = await res.json(); 
                    renderLikedQuotes(data.content); 
                } catch(e) { if(e.message !== "TOKEN_EXPIRED") listEl.innerHTML = "ë¡œë“œ ì‹¤íŒ¨"; }
            }
        }

        function renderLikedQuotes(likes) {
            const listEl = document.getElementById('mypage-list'); listEl.innerHTML = '';
            if (!likes || likes.length === 0) { listEl.innerHTML = `<div class="text-center text-gray-500 py-10 pixel-font">NO LIKES YET.</div>`; return; }
            likes.forEach(item => { 
                const date = new Date(item.createdAt).toLocaleDateString();
                const likeCount = item.likeCount != null ? item.likeCount : 0; 
                const isMyQuote = (myProfile.id === item.userId);
                
                let publicStatusBadge = '';
                if (isMyQuote && item.isPublic) {
                    const isPrivate = item.isPublic === 'PRIVATE';
                    publicStatusBadge = isPrivate 
                        ? `<span class="text-[10px] bg-red-200 text-red-800 px-1 border border-red-800 flex items-center gap-1"><i data-lucide="lock" class="w-3 h-3"></i>PRIVATE</span>` 
                        : `<span class="text-[10px] bg-blue-200 text-blue-800 px-1 border border-blue-800 flex items-center gap-1"><i data-lucide="globe" class="w-3 h-3"></i>PUBLIC</span>`;
                }

                const deleteButton = isMyQuote ? `<button onclick="deleteQuote(${item.quoteId})" class="p-2 hover:bg-gray-200 border border-transparent hover:border-black transition-all rounded-full ml-1" title="ì‚­ì œ"><i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i></button>` : '';
                const el = document.createElement('div'); el.className = 'retro-box p-0 mb-4'; 
                el.innerHTML = `
                    <div class="title-bar bg-white !border-b-2">
                         <div class="flex items-center min-w-0 flex-1 mr-2"><span class="text-sm truncate font-bold" title="${item.title}">${item.title}</span><span class="text-xs whitespace-nowrap flex-shrink-0 ml-1">(${item.pageNumber}p)</span></div>
                        <div class="flex gap-2 flex-shrink-0 items-center">
                            ${publicStatusBadge}
                            <span class="text-[10px] bg-gray-200 px-1 border border-black">${item.category}</span>
                        </div>
                    </div>
                    <div class="p-4 bg-[#fff]">
                        <p class="text-lg mb-4 leading-relaxed tracking-wide">"${item.sentence}"</p>
                        ${item.thought ? `<div class="bg-[#f0f9ff] p-3 text-sm border-2 border-dashed border-blue-300 mb-4 text-gray-600"><span class="font-bold mr-2 text-blue-500">ğŸ’­ THOUGHT:</span> ${item.thought}</div>` : ''}
                        <div class="flex justify-between items-end border-t-2 border-dotted border-gray-300 pt-3 mt-2">
                            <div class="flex flex-col"><span onclick="goToUserProfile(${item.userId})" class="text-xs font-bold cursor-pointer hover:underline text-blue-800">@${item.nickname}</span><span class="text-[10px] text-gray-500 font-mono">${date}</span></div>
                            <div class="flex gap-1 items-center"><span class="text-xs font-bold text-gray-500 pixel-font mr-1">${likeCount > 0 ? likeCount : ''}</span><button onclick="toggleLike(${item.quoteId}, ${item.id})" class="p-2 hover:bg-red-100 border border-transparent hover:border-black transition-all rounded-full active:scale-90"><i data-lucide="heart" class="w-4 h-4 fill-pink-500 text-pink-500"></i></button>${deleteButton}</div>
                        </div>
                    </div>`; 
                listEl.appendChild(el); 
            });
            lucide.createIcons();
        }

        async function goToMyPage() {
            document.getElementById('main-screen').classList.add('hidden'); 
            document.getElementById('mypage-screen').classList.remove('hidden'); 
            document.getElementById('user-profile-screen').classList.add('hidden'); 
            
            // [ìˆ˜ì •] ë§ˆì´í˜ì´ì§€ì—ì„œë„ ê¸€ì“°ê¸° ë²„íŠ¼ ë…¸ì¶œ (hidden í´ë˜ìŠ¤ ì œê±°)
            document.getElementById('fab-btn').classList.remove('hidden');

            if (!myProfile.nickname) { await fetchMyProfile(); }

            if(myProfile.nickname) { 
                document.getElementById('my-nickname').innerText = myProfile.nickname; 
                document.getElementById('my-email').innerText = myProfile.email; 
                document.getElementById('my-role').innerText = myProfile.userRole; 
                if(myProfile.profileUrl) { const img = document.getElementById('my-profile-img'); img.src = myProfile.profileUrl; img.classList.remove('hidden'); }
            }
            switchMyPageTab('my-quotes');
        }
        
        function showAuthScreen() { document.getElementById('auth-screen').classList.remove('hidden'); document.getElementById('main-screen').classList.add('hidden'); document.getElementById('mypage-screen').classList.add('hidden'); document.getElementById('user-profile-screen').classList.add('hidden'); document.getElementById('fab-btn').classList.add('hidden'); }
        function showMainScreen() { currentViewingUserId = null; document.getElementById('auth-screen').classList.add('hidden'); document.getElementById('mypage-screen').classList.add('hidden'); document.getElementById('user-profile-screen').classList.add('hidden'); document.getElementById('main-screen').classList.remove('hidden'); document.getElementById('fab-btn').classList.remove('hidden'); fetchQuotes(); }
        function openModal() { document.getElementById('modal-overlay').classList.remove('hidden'); }
        function closeModal() { document.getElementById('modal-overlay').classList.add('hidden'); document.getElementById('quote-form').reset(); }
        function showToast(msg) { const toast = document.getElementById('toast'); toast.innerText = msg; toast.classList.remove('hidden'); setTimeout(() => toast.classList.add('hidden'), 3000); }
    </script>
</body>
</html>